# ParentApproved v0.8 "The Audit"

## Haiku

```
four eyes read the code
leaked sessions, missing routes found
ship it, cleaned and true
```

## Release Goals

v0.8 is a **quality and correctness release** with no new features. It addresses findings from four independent reviews (architecture, security, test coverage, dev manager prioritization) of the v0.7.1 codebase. The goals are:

1. Fix all resource leaks and correctness bugs that degrade over time
2. Complete the relay allowlist so the v0.7.0 headline feature (time controls) works remotely
3. Eliminate thread safety hazards in shared mutable state
4. Remove the `runBlocking` ANR risk on real hardware
5. Harden security posture for public-facing relay and LAN-exposed endpoints

No new features, no dependency upgrades, no UI changes.

---

## Changes -- Tier 1: Release Blockers

### 1. Fix double session creation on PIN authentication

**Problem:** Every successful PIN auth creates two sessions. `PinManager.validate()` calls the `onPinValidated` callback (wired in `ServiceLocator` line 52 to `sessionManager.createSession()`), creating Session A. Then `AuthRoutes.kt` line 58 calls `sessionManager.createSession()` again, creating Session B. Session A is never returned to anyone -- it leaks. After 20 logins, 10 session slots are wasted (max 20 sessions, 90-day TTL).

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/server/AuthRoutes.kt` lines 57-59
- `tv-app/app/src/main/java/tv/parentapproved/app/ServiceLocator.kt` line 52

**What to do:** In `AuthRoutes.kt`, use the token already inside `PinResult.Success.token` instead of calling `createSession()` a second time:

```kotlin
// BEFORE (AuthRoutes.kt line 57-59):
is PinResult.Success -> {
    val token = sessionManager.createSession()
    call.respond(HttpStatusCode.OK, AuthResponse(success = true, token = token))
}

// AFTER:
is PinResult.Success -> {
    call.respond(HttpStatusCode.OK, AuthResponse(success = true, token = result.token))
}
```

**Acceptance criteria:** A single PIN auth produces exactly one entry in `SessionManager.sessions`. Verified by test.

**Test requirements:**
- `AuthRoutesTest`: Add test `pin auth creates exactly one session` -- authenticate, then check `sessionManager.getActiveSessionCount() == 1`.
- `AuthIntegrationTest`: Add test `20 sequential logins do not exhaust session pool` -- authenticate 20 times, verify last login still succeeds (currently fails after ~10 logins due to leaked sessions filling the pool).

**Estimated effort:** 30 minutes

---

### 2. Add time-limit routes to relay allowlist

**Problem:** The relay `allowlist.ts` does not include any `/api/time-limits` paths, and `PUT` is not in the `validMethods` set. Parents cannot manage time limits when using remote access via the relay. This is the v0.7.0 headline feature ("The Clock") broken over the relay -- the primary remote access path.

All four reviewers flagged this independently: Architecture (HIGH), Security (MEDIUM), Test Coverage (P0-CRITICAL), Dev Manager (Tier 1).

**Files to change:**
- `relay/src/allowlist.ts` -- add 5 route entries, add `PUT` to `validMethods`
- `relay/test/allowlist.test.ts` -- add tests for new routes
- `relay/test/integration.test.ts` -- add integration test for time-limit flow through relay

**What to do in `allowlist.ts`:**

Add to `ALLOWED_ROUTES` array (after the `/api/status` entry, line 20):
```typescript
  { pattern: /^\/api\/time-limits$/, methods: ["GET", "PUT"] },
  { pattern: /^\/api\/time-limits\/lock$/, methods: ["POST"] },
  { pattern: /^\/api\/time-limits\/bonus$/, methods: ["POST"] },
  { pattern: /^\/api\/time-limits\/request$/, methods: ["POST"] },
```

Add `PUT` to `validMethods` (line 45):
```typescript
const validMethods = new Set(["GET", "POST", "PUT", "DELETE"]);
```

**Acceptance criteria:** `isAllowed("/api/time-limits", "GET")`, `isAllowed("/api/time-limits", "PUT")`, `isAllowed("/api/time-limits/lock", "POST")`, `isAllowed("/api/time-limits/bonus", "POST")`, and `isAllowed("/api/time-limits/request", "POST")` all return `{ allowed: true }`.

**Test requirements:**
- `allowlist.test.ts`: Add 6 tests -- one for each allowed path+method, plus one verifying `PUT /api/time-limits/lock` is rejected (method not allowed for that path).
- `integration.test.ts`: Add test `time limit GET via relay returns config` and `time limit PUT via relay updates config`.

**Estimated effort:** 2 hours

---

### 3. Replace `HashMap` with `ConcurrentHashMap` in SessionManager

**Problem:** `SessionManager` uses a plain `HashMap<String, Long>` (line 11) accessed from multiple Ktor Netty threads concurrently. `validateSession()` is called on every authenticated request; `createSession()` and `refreshSession()` modify the map. Concurrent requests can cause `ConcurrentModificationException` or silent data corruption.

**File to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/auth/SessionManager.kt` line 11

**What to do:**

```kotlin
// BEFORE (line 11):
private val sessions = HashMap<String, Long>() // token -> createdAt

// AFTER:
private val sessions = java.util.concurrent.ConcurrentHashMap<String, Long>() // token -> createdAt
```

Also change `pruneExpired()` (line 67-70) since `ConcurrentHashMap.entries.removeAll` behaves differently:

```kotlin
// BEFORE:
private fun pruneExpired() {
    val now = clock()
    sessions.entries.removeAll { now - it.value > ttlMs }
}

// AFTER:
private fun pruneExpired() {
    val now = clock()
    sessions.entries.removeIf { now - it.value > ttlMs }
}
```

**Acceptance criteria:** `SessionManager` uses `ConcurrentHashMap`. No `ConcurrentModificationException` under concurrent access. All 19 existing `SessionManagerTest` tests still pass.

**Test requirements:**
- `SessionManagerTest`: Add test `concurrent session validation does not throw` -- launch 100 coroutines that call `validateSession()` and `createSession()` simultaneously, verify no exception.

**Estimated effort:** 15 minutes

---

### 4. Eliminate `runBlocking` in RoomTimeLimitStore

**Problem:** All four methods in `RoomTimeLimitStore` use `runBlocking` to call Room DAO suspend functions. `getConfig()` is called from `TimeLimitManager.canPlay()`, which is called from Compose `LaunchedEffect` contexts in `HomeScreen`, `PlaybackScreen`, and `LockScreen`. `runBlocking` inside a coroutine blocks the coroutine's thread. On the Mi Box (Android 9, slow eMMC storage), cold Room queries can take 50-100ms, causing jank or ANR.

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/timelimits/TimeLimitConfig.kt` lines 30-35 -- make `TimeLimitStore` interface methods `suspend`
- `tv-app/app/src/main/java/tv/parentapproved/app/timelimits/RoomTimeLimitStore.kt` -- remove `runBlocking` wrappers, make methods `suspend`
- `tv-app/app/src/main/java/tv/parentapproved/app/timelimits/TimeLimitManager.kt` -- make `canPlay()`, `getConfig()`, `updateConfig()`, `setManualLock()`, `grantBonus()` all `suspend`
- `tv-app/app/src/main/java/tv/parentapproved/app/server/TimeLimitRoutes.kt` -- route handlers are already suspend (Ktor routes), no change needed
- `tv-app/app/src/main/java/tv/parentapproved/app/ServiceLocator.kt` line 99-104 -- update no-op `TimeLimitStore` in `initForTest()` to have `suspend` methods
- `tv-app/app/src/test/java/.../TimeLimitManagerTest.kt` -- update all 33 tests to use `runTest { }` instead of direct calls
- `tv-app/app/src/test/java/.../TimeLimitRoutesTest.kt` -- update fake store to use `suspend`
- `tv-app/app/src/test/java/.../TimeLimitDaoTest.kt` -- update fake store

**What to do:**

In `TimeLimitConfig.kt`:
```kotlin
interface TimeLimitStore {
    suspend fun getConfig(): TimeLimitConfig?
    suspend fun saveConfig(config: TimeLimitConfig)
    suspend fun updateManualLock(locked: Boolean)
    suspend fun updateBonus(minutes: Int, date: String)
}
```

In `RoomTimeLimitStore.kt`, remove all `runBlocking` wrappers:
```kotlin
override suspend fun getConfig(): TimeLimitConfig? =
    dao.getConfig()?.toTimeLimitConfig()
```

In `TimeLimitManager.kt`, make methods suspend:
```kotlin
suspend fun canPlay(): TimeLimitStatus { ... }
```

**Acceptance criteria:** No `runBlocking` calls remain in `RoomTimeLimitStore`. `TimeLimitManager.canPlay()` is a `suspend fun`. All 33 `TimeLimitManagerTest` tests pass using `runTest`. All 21 `TimeLimitRoutesTest` tests pass.

**Test requirements:** All existing tests must pass after migration. No new tests needed; this is a refactor.

**Estimated effort:** 3 hours (ripples through 33+ tests)

---

### 5. Bump versionName in build.gradle.kts

**Problem:** `build.gradle.kts` line 18 says `versionName = "0.7.0"` but the latest commit is v0.7.1 and this release is v0.8. The app self-reports the wrong version in the `/status` endpoint and the connect screen.

**File to change:**
- `tv-app/app/build.gradle.kts` lines 17-18

**What to do:**
```kotlin
// BEFORE:
versionCode = 10
versionName = "0.7.0"

// AFTER:
versionCode = 11
versionName = "0.8.0"
```

**Acceptance criteria:** `GET /status` returns `"version": "0.8.0"`. Build succeeds.

**Test requirements:** Existing `StatusRoutesTest` verifies the version field exists. No new test needed.

**Estimated effort:** 5 minutes

---

## Changes -- Tier 2: Public Release Hardening

### 6. Make PlayEventRecorder thread-safe

**Problem:** `PlayEventRecorder` is an `object` singleton with mutable properties (`currentVideoId`, `isPlaying`, `pausedElapsedMs`, `currentStartTime`, etc.) read from the Ktor server thread (via `StatusRoutes`, `StatsRoutes`), the UI thread (via Compose screens), and the IO coroutine scope (via `scope.launch`). None are `@Volatile` or synchronized.

**File to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/data/events/PlayEventRecorder.kt`

**What to do:** Add `@Volatile` to all mutable properties that are read cross-thread:
```kotlin
@Volatile var currentVideoId: String? = null
    private set
@Volatile var currentPlaylistId: String? = null
    private set
@Volatile var currentTitle: String? = null
    private set
@Volatile var currentPlaylistTitle: String? = null
    private set
@Volatile var currentDurationMs: Long = 0
    private set
@Volatile var isPlaying: Boolean = false
    private set
@Volatile private var currentStartTime: Long = 0
@Volatile private var pausedElapsedMs: Long = 0
@Volatile private var currentEventId: Long? = null
```

**Acceptance criteria:** All mutable properties accessed cross-thread are `@Volatile`. All 11 `PlayEventRecorderTest` tests pass.

**Test requirements:** Existing tests verify behavior. No new tests needed.

**Estimated effort:** 30 minutes

---

### 7. Split `/status` endpoint into authenticated and unauthenticated responses

**Problem:** The `/status` endpoint requires no authentication. It exposes what the child is currently watching (video title, playlist, elapsed time, video ID) to anyone on the LAN or anyone who knows the tvId via the relay. This is privacy-sensitive data about a minor.

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/server/StatusRoutes.kt`
- `relay/assets/app.js` and `tv-app/app/src/main/assets/app.js` (if dashboard uses `/status` for connection check pre-auth)

**What to do:** Return minimal response when unauthenticated, full response when authenticated:

```kotlin
fun Route.statusRoutes(sessionManager: SessionManager) {
    get("/status") {
        val authHeader = call.request.header("Authorization")
        val token = authHeader?.removePrefix("Bearer ")
        val isAuthenticated = token != null && sessionManager.validateSession(token)

        if (!isAuthenticated) {
            call.respond(StatusResponse(
                version = BuildConfig.VERSION_NAME,
                serverRunning = true,
                playlistCount = 0,
                activeSessions = 0,
                currentlyPlaying = null,
            ))
            return@get
        }
        // ... existing full response ...
    }
}
```

**Acceptance criteria:** `GET /status` without auth returns only `version` and `serverRunning` (with zeroed counts and null `currentlyPlaying`). `GET /status` with valid token returns full response.

**Test requirements:**
- `StatusRoutesTest`: Add test `unauthenticated status returns minimal response` -- verify `currentlyPlaying` is null and `playlistCount` is 0.
- `StatusRoutesTest`: Add test `authenticated status returns full response` -- verify `currentlyPlaying` and counts are populated.

**Estimated effort:** 2 hours

---

### 8. Move DebugReceiver to debug-only manifest

**Problem:** `DebugReceiver` is registered with `android:exported="true"` in the main `AndroidManifest.xml` (lines 34-68) and ships in release builds. While `onReceive` checks `BuildConfig.IS_DEBUG`, the receiver should not be registered at all in release APKs.

**Files to change:**
- `tv-app/app/src/main/AndroidManifest.xml` -- remove `<receiver>` block
- `tv-app/app/src/debug/AndroidManifest.xml` -- create this file, add the `<receiver>` block

**Acceptance criteria:** `DebugReceiver` does not appear in the release APK manifest. Debug build still has all 18 intents working. All 12 `DebugReceiverIntentTest` instrumented tests pass (they run against debug variant).

**Test requirements:** Existing instrumented tests cover this. No new tests needed.

**Estimated effort:** 30 minutes

---

### 9. Use timing-safe PIN comparison

**Problem:** `PinManager.validate()` (line 53) uses `pin == currentPin` which compiles to `String.equals()`, a non-constant-time comparison. While the rate limiter (5 attempts, exponential backoff) makes timing attacks impractical, the relay already uses `crypto.subtle.timingSafeEqual` -- the TV-side should match.

**File to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/auth/PinManager.kt` line 53

**What to do:**
```kotlin
// BEFORE (line 53):
if (pin == currentPin) {

// AFTER:
if (java.security.MessageDigest.isEqual(pin.toByteArray(), currentPin.toByteArray())) {
```

**Acceptance criteria:** PIN comparison uses `MessageDigest.isEqual()`. All 13 `PinManagerTest` tests pass.

**Test requirements:** Existing tests verify correct/incorrect PIN behavior. No new tests needed.

**Estimated effort:** 15 minutes

---

### 10. Add CSP and security headers to dashboard responses

**Problem:** Neither the local Ktor server nor the relay sets Content-Security-Policy, X-Frame-Options, or X-Content-Type-Options headers on dashboard HTML responses.

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/server/DashboardRoutes.kt` -- add headers to HTML responses
- `relay/src/index.ts` -- add headers to static asset responses

**What to do:** Add these response headers to HTML responses:
```
Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://img.youtube.com https://i.ytimg.com
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Referrer-Policy: no-referrer
```

**Acceptance criteria:** `GET /` returns all four security headers. Relay dashboard responses include the same headers.

**Test requirements:**
- Add test to relay `security.test.ts`: `dashboard response includes security headers`.
- Add test to TV `DashboardRoutesTest` (new file or add to existing): `dashboard HTML includes security headers`.

**Estimated effort:** 1 hour

---

### 11. Fix `handleFullReset` video deletion bug

**Problem:** `DebugReceiver.handleFullReset()` (line 388) calls `videoDao().deleteByPlaylist("%")` which uses exact string match, not SQL LIKE. No videos are actually deleted during a full reset.

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/data/cache/PlaylistCacheDao.kt` -- add `deleteAll()` method
- `tv-app/app/src/main/java/tv/parentapproved/app/debug/DebugReceiver.kt` line 388

**What to do:**

In `PlaylistCacheDao.kt`, add:
```kotlin
@Query("DELETE FROM videos")
suspend fun deleteAll()
```

In `DebugReceiver.kt` line 388:
```kotlin
// BEFORE:
ServiceLocator.database.videoDao().deleteByPlaylist("%")

// AFTER:
ServiceLocator.database.videoDao().deleteAll()
```

**Acceptance criteria:** Full reset via debug intent deletes all cached videos. Verified by querying video count after reset.

**Test requirements:**
- `DebugReceiverIntentTest`: The existing `full reset clears everything` test should verify video count is 0 after reset (may already do this; verify).

**Estimated effort:** 15 minutes

---

### 12. Add CORS configuration to Ktor server

**Problem:** No CORS plugin installed on the Ktor server. Any website loaded in a browser on the LAN can make cross-origin requests to the TV's API and read responses, since there are no CORS restrictions.

**File to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/server/ParentApprovedServer.kt`

**What to do:** Install Ktor CORS plugin, allowing only the TV's own origin:
```kotlin
install(CORS) {
    anyHost()  // LAN IPs vary; phone connects from different IP each time
    allowHeader(HttpHeaders.Authorization)
    allowHeader(HttpHeaders.ContentType)
    allowMethod(HttpMethod.Put)
    allowMethod(HttpMethod.Delete)
}
```

**Acceptance criteria:** Ktor server responds with `Access-Control-Allow-Origin` header on API responses. Preflight OPTIONS requests are handled.

**Test requirements:** No dedicated test needed; CORS is a framework feature. Verify manually that dashboard still works.

**Estimated effort:** 30 minutes

---

### 13. Add relay Durable Object core tests

**Problem:** `RelayDurableObject` in `relay/src/relay.ts` handles WebSocket lifecycle, secret authentication, heartbeat monitoring, and request bridging. It has zero tests. This is the critical bridge for all remote access.

**File to create:**
- `relay/test/relay.test.ts`

**Tests to write (minimum viable set):**

| Test name | What it verifies |
|-----------|-----------------|
| `handleConnect accepts valid secret` | ConnectMessage with correct tvSecret is accepted |
| `handleConnect rejects invalid secret` | Wrong secret returns WebSocket close 4001 |
| `handleConnect replaces existing connection` | Second connect closes first with 4002 |
| `bridgeRequest returns 503 when TV offline` | No connected TV returns 503 |
| `bridgeRequest resolves on RelayResponse` | Full request/response cycle with correlation ID |
| `bridgeRequest times out after 10s` | TV doesn't respond returns 504 |
| `frame size enforcement rejects oversized` | >100KB frame closes with 4005 |
| `cleanupConnection rejects pending requests` | TV disconnects, all pending requests get 503 |

**Acceptance criteria:** All 8 tests pass. `npx vitest run` still passes all existing 139 tests.

**Test requirements:** Requires Miniflare DO test setup with WebSocket pairs.

**Estimated effort:** 3 days

---

### 14. Add ContentSourceRepository pure function tests

**Problem:** `buildCanonicalUrl()` and `extractVideoId()` are pure functions with no test coverage. They transform user-supplied URLs into canonical forms used throughout the app.

**File to create:**
- `tv-app/app/src/test/java/tv/parentapproved/app/data/ContentSourceRepositoryTest.kt`

**Tests to write:**

| Test name | What it verifies |
|-----------|-----------------|
| `buildCanonicalUrl for yt_channel with UC ID` | Returns `https://www.youtube.com/channel/UCxxx` |
| `buildCanonicalUrl for yt_channel with handle` | Returns `https://www.youtube.com/@handle` |
| `buildCanonicalUrl for yt_playlist` | Returns full playlist URL |
| `buildCanonicalUrl for yt_video` | Returns full video URL |
| `buildCanonicalUrl for unknown type` | Returns ID unchanged |
| `extractVideoId from v param` | Extracts `?v=xxx` |
| `extractVideoId from youtu.be` | Extracts path segment |
| `extractVideoId with no ID` | Returns null |

**Acceptance criteria:** All 8 tests pass.

**Estimated effort:** 30 minutes

---

### 15. Add dashboard XSS prevention test

**Problem:** Dashboard uses `innerHTML` with `escapeHtml()` for sanitization. The function works correctly, but there is no automated test proving it.

**File to create:**
- `tv-app/app/src/test/java/tv/parentapproved/app/util/EscapeHtmlTest.kt` (or add to relay dashboard tests)

**Tests to write (in relay `dashboard.test.ts` since `escapeHtml` lives in JS):**

| Test name | What it verifies |
|-----------|-----------------|
| `escapeHtml escapes script tags` | `<script>` becomes `&lt;script&gt;` |
| `escapeHtml escapes quotes` | `"` and `'` are escaped |
| `escapeHtml escapes ampersands` | `&` becomes `&amp;` |
| `escapeHtml handles empty string` | Returns empty string |

**Acceptance criteria:** All 4 tests pass and test the actual `escapeHtml` function from `app.js`.

**Estimated effort:** 30 minutes

---

### 16. Implement session token refresh in local dashboard

**Problem:** The dashboard (`app.js`) does not call `/auth/refresh` on page load. CLAUDE.md says it does, but the code does not implement this. Sessions can silently expire, leaving the parent locked out until they re-enter the PIN.

**Files to change:**
- `tv-app/app/src/main/assets/app.js`
- `relay/assets/app.js` (must stay in sync)

**What to do:** On page load, if a token exists in localStorage, call `POST /auth/refresh` with the token. If it returns a new token, update localStorage. If it returns 401, clear the token and show the PIN screen.

**Acceptance criteria:** Opening the dashboard with a valid token silently refreshes it. Opening with an expired token redirects to PIN entry.

**Test requirements:** Add test to relay `dashboard.test.ts`: `page load with valid token calls refresh endpoint`.

**Estimated effort:** 1 hour

---

## Changes -- Tier 3: Known Issues / Future Work

These are real findings that do not affect user experience or security posture at current scale. Deferred to future releases.

| # | Issue | Rationale for deferral |
|---|-------|----------------------|
| T3.1 | `StatusRoutes` directly accesses `ServiceLocator` singletons instead of taking parameters | Code hygiene; does not affect behavior |
| T3.2 | No API versioning prefix (`/v1/`) | Design decision; dashboard always ships with matching API |
| T3.3 | Inconsistent response formats (`"true"` string vs `true` boolean) | Cosmetic; dashboard handles both |
| T3.4 | Dependency version updates (Ktor 3.x, Room 2.7.x, etc.) | Non-trivial migration; no CVEs in current versions |
| T3.5 | Enable ProGuard/R8 for release builds | Needs ProGuard rules for NewPipe, Ktor; 4+ hours |
| T3.6 | Dashboard relay path prefix handling (`/tv/{tvId}/api/`) | Needs manual verification first; may already work |
| T3.7 | Restrict `usesCleartextTraffic` via `network_security_config.xml` | Local-first requires cleartext on LAN; mitigation is limited |
| T3.8 | `EncryptedSharedPreferences` for on-device secrets | Defense-in-depth; current `MODE_PRIVATE` is adequate |
| T3.9 | CI/CD pipeline (GitHub Actions for all 5 test suites) | Important but not a code issue; independent workstream |
| T3.10 | Full dashboard JSDOM test suite (25-30 tests) | Low ROI for 480-line JS file; add incrementally |
| T3.11 | Compose UI screen tests | Low ROI; screens are thin wrappers over tested logic |
| T3.12 | Relay Worker entry point (`index.ts`) tests | Worker is a thin routing layer; allowlist/rate-limit already tested |
| T3.13 | Move Ktor server lifecycle from Activity to Application | Edge case on Activity recreation; not observed in practice |
| T3.14 | Per-TV `localStorage` keys in dashboard | Multi-TV households are not the target use case yet |
| T3.15 | Clear PIN from QR code URL after auto-login (`history.replaceState`) | One-liner; low risk (PIN is displayed on TV screen anyway) |
| T3.16 | Room schema export (`exportSchema = true`) | Future migration safety; no migrations exist yet |
| T3.17 | Naming inconsistency (Playlist/Channel/Source) | Cosmetic; document and move on |
| T3.18 | `TimeLimitRoutes` closure-captured mutable state (`hasTimeRequest`, `lastRequestTime`) not thread-safe | Concurrent time-limit requests from two phones is an extreme edge case |

---

## New Tests Required

### TV App Unit Tests (`./gradlew testDebugUnitTest`)

| Test file | Test name | Verifies | Tied to |
|-----------|-----------|----------|---------|
| `AuthRoutesTest.kt` | `pin auth creates exactly one session` | No double session creation | Tier 1, #1 |
| `AuthIntegrationTest.kt` | `20 sequential logins do not exhaust session pool` | Session leak is fixed | Tier 1, #1 |
| `SessionManagerTest.kt` | `concurrent session validation does not throw` | ConcurrentHashMap works under load | Tier 1, #3 |
| `StatusRoutesTest.kt` | `unauthenticated status returns minimal response` | Split response privacy fix | Tier 2, #7 |
| `StatusRoutesTest.kt` | `authenticated status returns full response` | Split response still works for parents | Tier 2, #7 |
| `ContentSourceRepositoryTest.kt` | 8 tests (see #14 above) | Pure function correctness | Tier 2, #14 |

**Expected new TV unit test count: 194 + 13 = 207**

### TV App Unit Tests -- Modified (no new tests, but must pass after changes)

| Test file | Tests | Affected by |
|-----------|-------|-------------|
| `TimeLimitManagerTest.kt` | 33 tests migrated to `runTest { }` | Tier 1, #4 |
| `TimeLimitRoutesTest.kt` | 21 tests updated for suspend store | Tier 1, #4 |
| `TimeLimitDaoTest.kt` | 7 tests updated for suspend store | Tier 1, #4 |

### Relay Tests (`cd relay && npx vitest run`)

| Test file | Test name | Verifies | Tied to |
|-----------|-----------|----------|---------|
| `allowlist.test.ts` | `allows GET /api/time-limits` | Allowlist entry exists | Tier 1, #2 |
| `allowlist.test.ts` | `allows PUT /api/time-limits` | PUT method + route | Tier 1, #2 |
| `allowlist.test.ts` | `allows POST /api/time-limits/lock` | Lock route | Tier 1, #2 |
| `allowlist.test.ts` | `allows POST /api/time-limits/bonus` | Bonus route | Tier 1, #2 |
| `allowlist.test.ts` | `allows POST /api/time-limits/request` | Request route | Tier 1, #2 |
| `allowlist.test.ts` | `rejects PUT /api/time-limits/lock` | Method restriction | Tier 1, #2 |
| `integration.test.ts` | `time limit GET via relay returns config` | End-to-end relay flow | Tier 1, #2 |
| `integration.test.ts` | `time limit PUT via relay updates config` | End-to-end relay flow | Tier 1, #2 |
| `relay.test.ts` | 8 tests (see #13 above) | Durable Object core behavior | Tier 2, #13 |
| `dashboard.test.ts` | 4 XSS prevention tests (see #15 above) | escapeHtml correctness | Tier 2, #15 |
| `dashboard.test.ts` | `page load with valid token calls refresh` | Token refresh on load | Tier 2, #16 |
| `security.test.ts` | `dashboard response includes security headers` | CSP headers | Tier 2, #10 |

**Expected new relay test count: 139 + 22 = 161**

### Expected Total Test Count After v0.8

| Suite | Before | After | Delta |
|-------|--------|-------|-------|
| TV unit tests | 194 | 207 | +13 |
| TV instrumented | 19 | 19 | 0 |
| Relay tests | 139 | 161 | +22 |
| Landing page tests | 10 | 10 | 0 |
| Digest worker tests | 9 | 9 | 0 |
| **Total** | **371** | **406** | **+35** |

---

## Migration Notes

### Deployment Order

1. **Deploy relay first** (`cd relay && npx wrangler deploy`). The relay is backward compatible -- adding routes to the allowlist does not break anything. The old TV APK simply will not call the new routes.
2. **Deploy TV APK second** (`adb install -r app/build/outputs/apk/debug/app-debug.apk`). The new APK needs the updated relay allowlist for time-limit remote access to work.

### Backward Compatibility

- **Relay allowlist change**: Additive only. Old TVs/dashboards unaffected.
- **`TimeLimitStore` suspend migration**: Internal interface change. No external API changes. Dashboard and relay are unaffected.
- **SessionManager ConcurrentHashMap**: Drop-in replacement. `SharedPrefsSessionPersistence.save()` receives the same map interface.
- **`/status` split response**: The dashboard uses `/status` only for the connection indicator. The unauthenticated response still includes `serverRunning: true`, which is all the dashboard needs pre-auth. Post-auth, the dashboard sends the Bearer token and gets the full response.
- **Version bump**: No migration needed. `versionCode` increment from 10 to 11 is required for Play Store (if ever published).

### Data Migration

None. No database schema changes. Room version unchanged.

### Dashboard Sync Reminder

Changes to `app.js` (Tier 2 #16: token refresh) must be applied to **both** copies:
- `tv-app/app/src/main/assets/app.js`
- `relay/assets/app.js`

---

## Reviewer Sign-offs

**Senior Architect:** The double session leak and `runBlocking` ANR are correctness bugs that degrade the product over time. Fixing them plus the relay allowlist makes the architecture sound for public release.

**Security Researcher:** No critical vulnerabilities. The `/status` split response and timing-safe PIN comparison bring the security posture to an appropriate level for a family app. The DebugReceiver manifest move is defense-in-depth.

**Test Manager:** The 35 new tests close the highest-risk coverage gaps. The relay DO tests (Tier 2 #13) are the single most important testing investment and should not be deferred past the next relay deployment.

**Dev Manager:** Tier 1 is one focused day. Ship it, then start the relay DO test infrastructure immediately. The app has been working since v0.1 -- these fixes make it durable, not just functional.
