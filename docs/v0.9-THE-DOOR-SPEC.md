# ParentApproved v0.9 "The Door"

## Haiku

```
the door swings open
friends gather, install, and play
feedback lights the way
```

## Release Goals

v0.9 is the **friends-and-family distribution release**. The app works; now people need to be able to get it, install it, know what version they're running, report problems, and receive updates. No new viewing features. The goals are:

1. Ship a properly signed release APK that can be updated in-place forever
2. Make sideloading as painless as possible for non-technical parents
3. Give testers a clear feedback path and give ourselves crash visibility
4. Prepare the CI/CD foundation for automated builds on library updates
5. Open-source the repo with a proper license

---

## Signing & Key Management

### Release signing key

**Generate once, guard forever.** Losing this key means every existing user must uninstall and reinstall, losing their PIN, sessions, and content sources.

**Key generation:**
```
keytool -genkey -v \
  -keystore parentapproved-release.keystore \
  -alias parentapproved \
  -keyalg RSA -keysize 2048 \
  -validity 10000
```

**Key storage — three copies, three locations:**

| Copy | Location | Purpose |
|------|----------|---------|
| Primary | 1Password vault (or equivalent password manager) | Day-to-day signing, accessible from dev machine |
| CI/CD | GitHub Actions encrypted secret (`KEYSTORE_BASE64`, `KEY_ALIAS`, `KEY_PASSWORD`, `STORE_PASSWORD`) | Automated release builds |
| Cold backup | USB drive in a physically separate location (e.g. desk drawer, not the laptop bag) | Disaster recovery if cloud accounts are lost |

**Why not just the repo?** The keystore and its passwords must never be committed. A leaked key lets anyone sign APKs that Android treats as legitimate updates to the real app.

**`local.properties` approach for local builds:**
```properties
# Added to .gitignore, never committed
RELEASE_STORE_FILE=../parentapproved-release.keystore
RELEASE_STORE_PASSWORD=...
RELEASE_KEY_ALIAS=parentapproved
RELEASE_KEY_PASSWORD=...
```

**`build.gradle.kts` signing config** reads from `local.properties` for local builds, falls back to environment variables for CI. If neither exists, release signing is skipped (debug builds still work).

---

## Changes

### 1. Release build pipeline

**Problem:** Only debug APKs exist. No signing config, no release build, `isMinifyEnabled = false`.

**What to do:**
- Add `signingConfigs.release` to `build.gradle.kts` reading from `local.properties` / env vars
- Keep `isMinifyEnabled = false` for v0.9 — **defer R8/ProGuard to v0.9.1**. The app uses Ktor (reflection-heavy routing), kotlinx.serialization (runtime class resolution), NewPipeExtractor (large library with internal reflection), and Room (annotation-processed DAOs). Getting keep rules right for all four is a separate effort that shouldn't block the F&F release. The APK size difference (~5-10MB) is not a concern for sideload
- Wire `signingConfig = signingConfigs.getByName("release")` in the `release` block
- Test that `./gradlew assembleRelease` produces a working, signed APK
- Verify the release APK installs and runs correctly on Mi Box and emulator
- Verify a second release APK (with bumped versionCode) installs over the first without data loss

**Files to change:**
- `tv-app/app/build.gradle.kts`
- `tv-app/.gitignore` (add keystore, local.properties if not already there)

### 2. Version visibility everywhere

**Problem:** Version is only visible in debug builds (ConnectScreen) and the settings panel. Parents using the dashboard have no idea what version is running. The landing page still says `0.3-beta`.

**What to do:**
- **ConnectScreen**: show version in both debug and release builds (remove the `IS_DEBUG` gate)
- **Dashboard**: add a small version footer to the dashboard HTML (e.g. `v0.9.0` bottom-right of the page). The dashboard already calls `/api/status` which returns `version` — display it
- **Landing page**: update the JSON-LD `softwareVersion`, update the visible download section (see change #4)
- **`/api/status` response**: add `protocolVersion` field to `PublicStatusResponse` — the dashboard JS already checks for it but the Kotlin response doesn't include it

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/ui/screens/ConnectScreen.kt`
- `tv-app/app/src/main/assets/app.js` + `relay/assets/app.js` (dashboard sync)
- `tv-app/app/src/main/assets/index.html` + `relay/assets/index.html` (dashboard sync)
- `tv-app/app/src/main/java/tv/parentapproved/app/server/StatusRoutes.kt`
- `marketing/landing-page/index.html`

### 3. Feedback channel

**Problem:** No way for testers to report problems. The dashboard has no feedback link. The landing page has a placeholder GitHub URL (`github.com/user/kidswatch`).

**What to do:**
- **Dashboard**: add a "Report a Problem" link in the dashboard footer. Opens a `mailto:hello@parentapproved.tv` with pre-filled subject: `[ParentApproved v{version}] Feedback` and body template including device info if available
- **Landing page**: fix the GitHub URL placeholders to the real repo URL (once the repo is public) or remove them until then. Keep the `mailto:hello@parentapproved.tv` as the primary feedback channel
- **ConnectScreen**: no change needed — parents use the dashboard, not the TV screen, for feedback

**Files to change:**
- `tv-app/app/src/main/assets/app.js` + `relay/assets/app.js`
- `tv-app/app/src/main/assets/index.html` + `relay/assets/index.html`
- `marketing/landing-page/index.html`

### 4. Download page

**Problem:** The landing page download section is a "coming soon" email signup form, not an actual download.

**What to do:**
- Replace the email signup with an actual download section containing:
  - **Download button**: links to GitHub Releases stable URL (`https://github.com/Prasanna79/parentapproved/releases/latest/download/ParentApproved.apk`)
  - **Version number and release notes** shown next to the button — fetched client-side from `version.json` so the download page stays current without manual HTML edits on every release
  - **Sideload instructions** (see change #5)
- APK is hosted on GitHub Releases (created automatically by `release.yml` — see change #9). `release.yml` also auto-updates `version.json`, so the download page version is always in sync
- Keep the email signup as a secondary element ("Get notified of updates")

**Files to change:**
- `marketing/landing-page/index.html`
- `marketing/landing-page/style.css` (if download section needs new styles)

### 5. Sideload install guide

**Problem:** Non-technical parents won't know how to install an APK on their Android TV.

**What to do:**
- Add an install guide section on the download page (or a linked page) covering:
  - **Method 1 — "Downloader" app** (recommended for most users): install "Downloader by AFTVnews" from Play Store on the TV, enter the short URL, it downloads and installs. This is the lowest-friction path for Fire TV and most Android TV boxes
  - **Method 2 — "Send Files to TV"**: install on both phone and TV from Play Store, send the APK from phone to TV, open and install
  - **Method 3 — USB drive**: download APK on computer, copy to USB, plug into TV, use a file manager to install
  - **Method 4 — `adb install`** (technical users only): one-liner command
  - **Common prerequisite**: enable "Install from unknown sources" — provide paths for: Google TV, Xiaomi Mi Box, Fire TV, generic Android TV
- Keep it scannable: numbered steps, screenshots optional for v0.9 (can add later)

**Files to change:**
- `marketing/landing-page/index.html` (inline guide or new section)

### 6. Crash visibility

**Problem:** No crash handling exists. When the app crashes on a tester's TV, we have zero visibility. Friends won't run `adb logcat`.

**What to do:**
- Install a `Thread.setDefaultUncaughtExceptionHandler` in `ParentApprovedApp.onCreate()`. Save a reference to the previous default handler before replacing it
- On crash: write the stack trace, app version, device model, Android version, and timestamp to a file in the app's internal storage (e.g. `crash_log.txt`, keep last 5 crashes, cap total size at 100KB). **Then delegate to the previous default handler** to let the system terminate the process normally. If the handler just returns without delegating, the crashing thread dies but the process may linger as a zombie
- **Dashboard endpoint**: add `GET /api/crash-log` (authenticated) that returns the crash log contents
- **Dashboard UI**: add a "Last crash" indicator in the dashboard — if a crash log exists, show a small banner or entry in a diagnostics section. Include a "Copy to clipboard" button so parents can paste it into a feedback email
- On next app launch after a crash: log that a crash was recovered from (helps with logcat debugging when we do have access)

**Files to change:**
- `tv-app/app/src/main/java/tv/parentapproved/app/ParentApprovedApp.kt`
- `tv-app/app/src/main/java/tv/parentapproved/app/CrashHandler.kt` (new)
- `tv-app/app/src/main/java/tv/parentapproved/app/server/` (new crash-log route)
- `tv-app/app/src/main/assets/app.js` + `relay/assets/app.js`
- Relay allowlist update for `/api/crash-log`

### 7. Update-available check

**Problem:** Sideloaded apps have no auto-update. Users will run stale versions indefinitely and report bugs we've already fixed.

**What to do:**
- **Version manifest**: host a tiny JSON file on the website at a stable URL (e.g. `parentapproved.tv/version.json`):
  ```json
  {
    "latest": "0.9.1",
    "latestCode": 13,
    "url": "https://github.com/Prasanna79/parentapproved/releases/latest/download/ParentApproved.apk",
    "releaseNotes": "Bug fixes and performance improvements"
  }
  ```
- **TV-side check**: on app startup (and once every 24 hours while running), fetch `version.json`, compare `latestCode` to `BuildConfig.VERSION_CODE`
- **If update available**: show a subtle, non-blocking banner on the ConnectScreen: "Update available (v0.9.1) — visit parentapproved.tv/download". Do NOT show this during video playback or on the home screen (kids don't need to see it)
- **Dashboard**: show an "Update available" badge next to the version in the footer if stale
- **No auto-download, no in-app install** — just awareness. The parent downloads the new APK the same way they got the first one

**Files to change:**
- `marketing/landing-page/version.json` (new, deployed with Pages)
- `tv-app/app/src/main/java/tv/parentapproved/app/UpdateChecker.kt` (new)
- `tv-app/app/src/main/java/tv/parentapproved/app/ui/screens/ConnectScreen.kt`
- `tv-app/app/src/main/assets/app.js` + `relay/assets/app.js`
- `tv-app/app/src/main/java/tv/parentapproved/app/ServiceLocator.kt`

### 8. License and open-source prep

**Problem:** No LICENSE file. GitHub URL placeholders point to a non-existent repo.

**What to do:**
- Add `LICENSE` file at repo root. Recommended: **AGPL-3.0** — it's the strongest copyleft (requires anyone who modifies and runs the server/relay to share their changes), which aligns with "open source forever". If that's too restrictive for downstream use, MIT or Apache-2.0 are simpler alternatives
- Add license header mention in README (or CLAUDE.md)
- Add a one-line "charityware" note in the LICENSE or a separate `CONTRIBUTING.md`: "This software is free. If it's useful to you, consider donating to [mettavipassana.org](https://mettavipassana.org)"
- **Audit the working tree** for any secrets, credentials, or personal info before making it public: `local.properties`, `.env` files, hardcoded IPs, etc. Add these to `.gitignore` if not already there
- **Audit the git history** — secrets that were committed and later removed are still in history. Run: `git log --all --diff-filter=A --name-only -- '*.properties' '*.env' '*.keystore' '*.json' '*.key' '*.pem'` to check if any sensitive files were ever committed. If found, use `git filter-repo` to scrub them before making the repo public
- Fix all `github.com/user/kidswatch` placeholder URLs to `https://github.com/Prasanna79/parentapproved`

**Files to change:**
- `LICENSE` (new)
- `.gitignore` (audit)
- `marketing/landing-page/index.html` (fix GitHub URLs to `https://github.com/Prasanna79/parentapproved`)
- Possibly `CLAUDE.md`, `README.md`

### 9. CI/CD foundation (GitHub Actions)

**Problem:** No CI exists. Builds are manual. The eventual goal is automated builds triggered by library updates (NewPipeExtractor, Media3, etc.).

**What to do for v0.9** (foundation only, not full automation):

- **`.github/workflows/build.yml`** — runs on every push and PR:
  - Checkout, set up JDK 17, set up Android SDK
  - `./gradlew testDebugUnitTest` — unit tests
  - `cd relay && npm ci && npx vitest run` — relay tests
  - `./gradlew assembleDebug` — build verification
  - Cache Gradle and npm dependencies

- **`.github/workflows/release.yml`** — manually triggered (`workflow_dispatch`) with version input:
  - Same as build, plus:
  - Decode keystore from `KEYSTORE_BASE64` secret
  - `./gradlew assembleRelease` — produce signed APK
  - Run instrumented tests on Firebase Test Lab (see change #10)
  - Create GitHub Release with signed APK attached
  - Auto-update `version.json` with new `latestCode`, `latest` version name, and release notes from the workflow input, then deploy the landing page to Cloudflare Pages (`npx wrangler pages deploy`). This ensures `version.json` is never out of sync with the GitHub Release — the same workflow that publishes the APK also publishes the version manifest
  - Requires `CLOUDFLARE_API_TOKEN` (use "Edit Cloudflare Workers" template — includes Cloudflare Pages:Edit) and `CLOUDFLARE_ACCOUNT_ID` as GitHub Actions secrets

- **APK hosting: GitHub Releases, not Cloudflare Pages**

  The download button on parentapproved.tv should link to the GitHub Releases asset URL, not host the APK inside Cloudflare Pages. Reasons:

  - **CI/CD writes it automatically.** `release.yml` builds the APK, creates a GitHub Release, and attaches the artifact — done. No separate deploy step, no copying files between services, no second credential to manage
  - **Versioned by default.** Every GitHub Release is a permanent, versioned snapshot (tag, changelog, APK). Old versions stay downloadable. Cloudflare Pages is designed for "latest only" static sites
  - **`version.json` stays on Cloudflare Pages** (it's a tiny file updated with the landing page). It points `url` at the GitHub Releases download link for the latest APK
  - **Stable download URL pattern:** `https://github.com/Prasanna79/parentapproved/releases/latest/download/ParentApproved.apk` — GitHub redirects this to the latest release's asset automatically. This is what the download button and `version.json` link to
  - **File size limits are fine.** GitHub Releases allows assets up to 2GB. Cloudflare Pages has a 25MB per-file limit which an APK could exceed as the app grows

- **Not in v0.9 scope** (future work):
  - Automated deploy smoke tests in CI

**Files to change:**
- `.github/workflows/build.yml` (new)
- `.github/workflows/release.yml` (new)

### 10. Firebase Test Lab for instrumented tests in CI

**Problem:** 19 instrumented tests exist but only run locally. The app requires `android.software.leanback` (TV system image), which makes emulator-in-CI flaky and slow. We need instrumented test results before cutting a release.

**What to do:**
- Create a GCP/Firebase project for test infrastructure only. **Blaze plan (pay-as-you-go) required** — Test Lab is not available on the free Spark plan. Set a budget alert at $5/month. Actual cost: ~$0.10 per 5-minute test run, under $5/year at a weekly release cadence
- Create a GCP service account with the following roles:
  - `Firebase Test Lab Admin`
  - `Storage Admin` (required to manage the results bucket)
  - `Viewer` (at the project level)
- In `release.yml`, after `assembleRelease` and `assembleDebugAndroidTest`:
  - Authenticate with Firebase via a service account key (stored as GitHub Actions secret `FIREBASE_SERVICE_ACCOUNT`)
  - Use `gcloud firebase test android run` to upload the APK + test APK
  - Target: `--type instrumentation --device model=GoogleTV,version=34` (or nearest available TV device). Fall back to `model=MediumPhone.arm,version=34` if no TV device is available — the instrumented tests exercise Ktor routes and Room DB, not TV-specific UI
  - `--timeout 5m` — 19 tests shouldn't take longer
  - `--project ${{ secrets.GCP_PROJECT_ID }}` — explicitly specify the project
  - `--results-bucket=${{ secrets.GCP_PROJECT_ID }}-test-results` — use a project-local bucket to avoid cross-project permission issues
- Parse the exit code: if tests fail, the release workflow fails before the GitHub Release is created — no broken APK gets published

**Clarification on "anti-cloud":** the principle is that the *app* doesn't require cloud accounts from parents or kids. Dev infrastructure (GitHub, Cloudflare, Firebase Test Lab) is fair game — same as any CI service.

**Files to change:**
- `.github/workflows/release.yml` (add Firebase Test Lab step)
- GitHub Actions secrets:
  - `FIREBASE_SERVICE_ACCOUNT` (service account JSON, base64-encoded)
  - `GCP_PROJECT_ID` (your GCP project ID)

### 11. Dependabot for automated dependency updates

**Problem:** NewPipeExtractor is the YouTube extraction layer. When YouTube changes things, NewPipe ships a fix. Without automated monitoring, we find out when a user reports "videos stopped loading." Same risk with Media3, Ktor, OkHttp, and the relay's npm dependencies.

**What to do:**
- Add `.github/dependabot.yml` with four ecosystems:
  - **Gradle** (`/tv-app`): weekly schedule, monitor all direct dependencies
  - **npm** (`/relay`): weekly schedule, monitor all direct dependencies
  - **npm** (`/marketing/landing-page`): weekly schedule
  - **npm** (`/marketing/notify-digest`): weekly schedule
- Use Dependabot's `groups` feature to batch related libraries into single PRs:
  - `media3` group: `media3-exoplayer`, `media3-exoplayer-dash`, `media3-ui`
  - `ktor` group: all `io.ktor:ktor-*` dependencies
  - `compose` group: all `androidx.compose:*` dependencies
  - `room` group: `room-runtime`, `room-ktx`, `room-compiler`
- Set `open-pull-requests-limit: 5` per ecosystem to avoid PR noise
- CI (`build.yml` from change #9) runs automatically on Dependabot PRs — if tests pass, the update is safe to merge. If tests fail (especially NewPipeExtractor), that's your signal that the update needs manual attention

**Why Dependabot over Renovate:** zero config beyond the YAML file, built into GitHub (no third-party app access), sufficient for ~15 direct dependencies across two ecosystems. Can switch to Renovate later if grouping or auto-merge needs outgrow it.

**Files to change:**
- `.github/dependabot.yml` (new)

### 12. `usesCleartextTraffic` documentation

**Problem:** The manifest has `android:usesCleartextTraffic="true"` which may alarm security-conscious testers.

**What to do:**
- Add a `network_security_config.xml` that restricts cleartext to `localhost` and `10.0.0.0/8`, `192.168.0.0/16`, `172.16.0.0/12` (RFC 1918 private ranges) — this is where the Ktor server lives
- Reference it in the manifest: `android:networkSecurityConfig="@xml/network_security_config"`
- Remove `android:usesCleartextTraffic="true"` from the manifest (the config file replaces it)
- This is more precise and documents the intent: "cleartext is only for local network communication with the embedded server"

**Files to change:**
- `tv-app/app/src/main/res/xml/network_security_config.xml` (new)
- `tv-app/app/src/main/AndroidManifest.xml`

---

## Version Bumping

- `versionCode`: bump to `12` (from `11`)
- `versionName`: `"0.9.0"`
- Every subsequent APK distributed to anyone must increment `versionCode`. Document this in CLAUDE.md

## Protocol Version Policy

**Never bump `PROTOCOL_VERSION` without a grace period.** The relay currently does a strict equality check — if the TV sends any version other than the expected one, the relay closes the WebSocket immediately with no recovery. With sideloaded users who update on their own schedule, version skew is inevitable.

**Rule for future protocol changes:**
- The relay must accept **current version and previous version** for at least 30 days after a new version is deployed
- The update-available check (change #7) gives us a channel to nudge users to update before the grace period ends
- The relay's WebSocket close reason should include the expected version so the TV can display a meaningful message (e.g. "Please update ParentApproved to continue using remote access")
- Document this in CLAUDE.md under "What NOT to Do"

**v0.9 does not change the protocol version** (stays at 1). This policy is for future releases.

---

## Test Plan

### New unit tests
- `CrashHandler`: verify it writes crash file, respects size cap, keeps only last 5
- `UpdateChecker`: verify it parses version.json, correctly compares version codes, handles network errors gracefully (no crash on timeout/404)
- `StatusRoutes`: verify `protocolVersion` is included in response
- Crash-log route: verify auth required, returns file contents, handles no-crash-file case

### Updated tests
- Route-alignment test: add `/api/crash-log` to relay allowlist
- Dashboard parity test: both copies have version footer and feedback link

### Manual verification
- Install release APK over previous release APK — no data loss
- Install release APK over debug APK — expect it to fail (different signing key, that's correct)
- "Downloader" app flow on a real Android TV device
- Update-available banner appears when version.json has a higher version
- Crash handler triggers on a forced crash (throw an exception via debug intent)
- Feedback mailto link opens correctly on phone browser

### CI verification
- `build.yml` passes on a push to main
- `release.yml` produces a downloadable signed APK attached to a GitHub Release
- Firebase Test Lab runs instrumented tests during `release.yml` and reports pass/fail
- GitHub Releases download URL works from a browser (test the stable `/latest/download/` redirect)
- `version.json` on parentapproved.tv is auto-updated by `release.yml` with correct `latestCode` and `url`
- Dependabot opens its first batch of PRs within a week of merge
- `build.yml` runs on Dependabot PRs and reports pass/fail

---

## What's NOT in v0.9

- No new viewing features (no new content source types, no UI changes to home/playback)
- No auto-update / in-app APK download
- No Play Store or F-Droid submission (sideload only)
- No R8/ProGuard minification (deferred to v0.9.1 — needs careful keep rules for Ktor, kotlinx.serialization, NewPipeExtractor, Room)
- No Dependabot auto-merge (PRs are opened, human merges after reviewing CI results)
- No analytics or telemetry (stays local-first)
- No user accounts or cloud storage

---

## Rollout Plan

### Phase 0: Account setup (before any code)
1. **Generate release signing key** — `keytool` command from Signing section above
2. **Back up signing key** — 1Password vault + cold USB backup
3. **Create GitHub repo** — `https://github.com/Prasanna79/parentapproved` (private for now, public when ready)
4. **Add GitHub Actions secrets**: `KEYSTORE_BASE64`, `KEY_ALIAS`, `KEY_PASSWORD`, `STORE_PASSWORD`
5. **Create GCP/Firebase project** — for Test Lab only, create service account with Test Lab permissions
6. **Add GitHub Actions secret**: `FIREBASE_SERVICE_ACCOUNT` (service account JSON, base64-encoded)
7. **Add GitHub Actions secrets**: `CLOUDFLARE_API_TOKEN` (created from "Edit Cloudflare Workers" template, which includes Pages:Edit), `CLOUDFLARE_ACCOUNT_ID` (`97c156bde0fe13fb540a787ef25c427e`)
8. **Audit git history** for secrets before making repo public (see change #8)

### Phase 1: Implementation
9. Implement changes 1-12 with tests
10. Run full verification suite (unit + relay + Playwright + smoke)

### Phase 2: Validation
11. Push to GitHub, verify `build.yml` passes
12. Trigger `release.yml`, verify it produces a signed APK + GitHub Release + updated `version.json`
13. Verify Firebase Test Lab runs instrumented tests and reports results
14. Install release APK on Mi Box, test for 24 hours
15. Verify GitHub Releases download URL works from a browser

### Phase 3: Distribution
16. Deploy updated relay
17. Make repo public (if ready)
18. Send the link to 3-5 friends, collect feedback for one week
19. Fix any issues, ship v0.9.1 if needed (with R8/ProGuard minification)
20. Broader friends-and-family distribution

---

## CLAUDE.md Updates After v0.9

- Add signing key location and `assembleRelease` instructions
- Update test counts
- Add CI badge and workflow descriptions
- Add `versionCode` increment reminder to release checklist
- Document the charityware / license status
