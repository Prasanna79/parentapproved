name: Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g. 0.9.0)'
        required: true
      version_code:
        description: 'Version code (integer, must increment)'
        required: true
      release_notes:
        description: 'Release notes (shown on download page)'
        required: true
        default: 'Bug fixes and improvements'

jobs:
  build-and-release:
    name: Build, Test & Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('tv-app/**/*.gradle*', 'tv-app/**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      # --- Unit tests ---
      - name: Run unit tests
        working-directory: tv-app
        run: ./gradlew testDebugUnitTest

      # --- Relay tests ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: relay/package-lock.json

      - name: Install relay dependencies
        working-directory: relay
        run: npm ci

      - name: Run relay tests
        working-directory: relay
        run: npx vitest run

      # --- Decode signing key ---
      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > tv-app/release.keystore

      # --- Build release APK ---
      - name: Build release APK
        working-directory: tv-app
        env:
          RELEASE_STORE_FILE: release.keystore
          RELEASE_STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      # --- Rename APK ---
      - name: Rename APK
        run: cp tv-app/app/build/outputs/apk/release/app-release.apk ParentApproved.apk

      # --- Firebase Test Lab ---
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Build debug + test APKs
        working-directory: tv-app
        run: ./gradlew assembleDebug assembleDebugAndroidTest

      - name: Run instrumented tests on Firebase Test Lab
        run: |
          gcloud firebase test android run \
            --type instrumentation \
            --app tv-app/app/build/outputs/apk/debug/app-debug.apk \
            --test tv-app/app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --device model=MediumPhone.arm,version=34 \
            --timeout 5m \
            --no-record-video

      # --- Create GitHub Release ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version_name }}
          name: ParentApproved v${{ inputs.version_name }}
          body: ${{ inputs.release_notes }}
          files: ParentApproved.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Update version.json and deploy landing page ---
      - name: Update version.json
        run: |
          cat > marketing/landing-page/version.json << 'JSONEOF'
          {
            "latest": "${{ inputs.version_name }}",
            "latestCode": ${{ inputs.version_code }},
            "url": "https://github.com/Prasanna79/parentapproved/releases/latest/download/ParentApproved.apk",
            "releaseNotes": "${{ inputs.release_notes }}"
          }
          JSONEOF

      - name: Deploy landing page
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy marketing/landing-page --project-name parentapproved-tv
